#!/bin/sh

set -e

echo "ğŸ” Running pre-push checks..."

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®@pre-pushãƒã‚§ãƒƒã‚¯
echo "ğŸ“ Checking @pre-push tag..."
if ! git log -1 --pretty=%B | grep -q "@pre-push"; then
    echo "âŒ Error: Commit message must include @pre-push tag"
    exit 1
fi
echo "âœ… @pre-push tag check passed"

# Lintãƒã‚§ãƒƒã‚¯
echo "ğŸ§¹ Running linter checks..."

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
echo "ğŸ“ Verifying formatting..."
if ! ruff format --check --diff; then
    echo "âŒ Format check failed"
    exit 1
fi
echo "âœ… Format check passed"

# Lintãƒã‚§ãƒƒã‚¯
echo "ğŸ” Running linter..."
if ! ruff check --diff; then
    echo "âŒ Lint check failed"
    exit 1
fi
echo "âœ… Lint check passed"

# å‹ãƒã‚§ãƒƒã‚¯
echo "ğŸ” Running mypy checks..."
if ! mypy ./src; then
    echo "âŒ Mypy check failed"
    exit 1
fi
echo "âœ… Mypy check passed"

# ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
echo "ğŸ§ª Running tests..."
if ! pytest -v ./tests --cov=./src --cov-report term-missing --durations=5; then
    echo "âŒ Tests failed"
    exit 1
fi
echo "âœ… Tests passed"

echo "âœ… All checks passed! Ready to push."
